{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{371:function(s,a,t){\"use strict\";t.r(a);var e=t(46),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[t(\"h2\",{attrs:{id:\"介绍\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#介绍\"}},[s._v(\"#\")]),s._v(\" 介绍\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"haproxy\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#haproxy\"}},[s._v(\"#\")]),s._v(\" HAProxy\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"环境安装\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#环境安装\"}},[s._v(\"#\")]),s._v(\" 环境安装\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"yum-安装\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#yum-安装\"}},[s._v(\"#\")]),s._v(\" yum 安装\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"yum \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" haproxy\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#配置 HAProxy\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" /etc/haproxy/haproxy.cfg\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#启动 HAProxy\")]),s._v(\"\\nhaproxy -f /etc/haproxy/haproxy.cfg\\n\\nsystemctl start haproxy.service\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#停止 HAProxy\")]),s._v(\"\\nsystemctl stop haproxy.service\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\")])]),t(\"h3\",{attrs:{id:\"源码安装\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#源码安装\"}},[s._v(\"#\")]),s._v(\" 源码安装\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[s._v(\"下载并解压\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#安装依赖\")]),s._v(\"\\nyum \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" openssl openssl-devel systemd-devel\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#https://www.haproxy.org （国内无法打开）\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#http://pkgs.fedoraproject.org/repo/pkgs/haproxy/\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"wget\")]),s._v(\" https://src.fedoraproject.org/repo/pkgs/haproxy/haproxy-2.1.4.tar.gz/sha512/fd029ac1ec877fa89a9410944439b66795b1392b6c8416aaa7978943170530c3826ba50ea706366f3f7785b7cffed58497cb362fc2480dd6920a99af4f920d98/haproxy-2.1.4.tar.gz\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"tar\")]),s._v(\" -zxvf haproxy-2.1.4.tar.gz -C /usr/local\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"2\"}},[t(\"li\",[s._v(\"编译并安装\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token builtin class-name\"}},[s._v(\"cd\")]),s._v(\" /usr/local/haproxy-2.1.4\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"uname\")]),s._v(\" -r\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#开启https USE_OPENSSL=1\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#开启haproxy进程与CPU核心绑定 USE_CPU_AFFINITY=1\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#支持使用 -Ws参数（systemd-aware master-worker 模式）启动Haproxy USE_SYSTEMD=1\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"make\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"ARCH\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"x86_64 \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"TARGET\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"linux-glibc \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"USE_PCRE\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"USE_OPENSSL\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"USE_ZLIB\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"USE_SYSTEMD\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"USE_CPU_AFFINITY\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"PREFIX\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"/usr/local/haproxy\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"make\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"PREFIX\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"/usr/local/haproxy\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"cp\")]),s._v(\" haproxy /usr/sbin/\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\")])]),t(\"div\",{staticClass:\"custom-block warning\"},[t(\"p\",{staticClass:\"custom-block-title\"},[s._v(\"WARNING\")]),s._v(\" \"),t(\"p\",[s._v(\"HAProxy2.0 版本后 移除了 TARGET=linux2628\")]),s._v(\" \"),t(\"div\",{staticClass:\"language- line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[s._v(\"Target 'linux2628' was removed from HAProxy 2.0 due to being irrelevant and\\noften wrong. Please use 'linux-glibc' instead or define your custom target\\nby checking available options using 'make help TARGET=<your-target>'\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\")])])]),s._v(\" \"),t(\"p\",[s._v(\"PREFIX 为指定的安装路径，TARGET 则根据当前操作系统内核版本指定\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"linux22 for Linux 2.2\")]),s._v(\" \"),t(\"li\",[s._v(\"linux24 for Linux 2.4 and above (default)\")]),s._v(\" \"),t(\"li\",[s._v(\"linux24e for Linux 2.4 with support for a working epoll (> 0.21)\")]),s._v(\" \"),t(\"li\",[s._v(\"linux26 for Linux 2.6 and above\")]),s._v(\" \"),t(\"li\",[s._v(\"linux2628 for Linux 2.6.28, 3.x, and above (enables splice and tproxy)\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"配置\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#配置\"}},[s._v(\"#\")]),s._v(\" 配置\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[s._v(\"配置用户\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"groupadd\")]),s._v(\" haproxy\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"useradd\")]),s._v(\" -g haproxy haproxy -s /sbin/nologin\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"2\"}},[t(\"li\",[s._v(\"配置文件\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"mkdir\")]),s._v(\" /etc/haproxy\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"mkdir\")]),s._v(\" /etc/haproxy/conf\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"cat\")]),s._v(\" /etc/haproxy/haproxy.cfg\\n\\n\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"3\"}},[t(\"li\",[s._v(\"注册到系统服务\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" /usr/lib/systemd/system/haproxy.service\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"Unit\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"Description\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"HAProxy Load Balancer\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"After\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"syslog.target network.target\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"Service\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"ExecStartPre\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf -c -q\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"ExecStart\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf -p /run/haproxy.pid\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"ExecReload\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"/bin/kill -USR2 \"),t(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"$MAINPID\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"Install\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"WantedBy\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"multi-user.target\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"4\"}},[t(\"li\",[s._v(\"启动 haproxy 服务\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"systemctl daemon-reload\\nsystemctl start haproxy\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\")])]),t(\"h3\",{attrs:{id:\"keepalived\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#keepalived\"}},[s._v(\"#\")]),s._v(\" KeepAlived\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[s._v(\"下载并解压\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#安装依赖\")]),s._v(\"\\nyum \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" openssl openssl-devel\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#下载\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"wget\")]),s._v(\" https://www.keepalived.org/software/keepalived-2.0.20.tar.gz\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"tar\")]),s._v(\" -zxvf keepalived-2.0.20.tar.gz -C /usr/local/\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"2\"}},[t(\"li\",[s._v(\"编译并安装\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token builtin class-name\"}},[s._v(\"cd\")]),s._v(\" /usr/local/keepalived-2.0.20\\n./configure --prefix\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"/usr/local/keepalived\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"make\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"&&\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"make\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"cp\")]),s._v(\" /usr/local/keepalived/sbin/keepalived /usr/sbin/\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"3\"}},[t(\"li\",[s._v(\"启动 KeepAlived 服务\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"mkdir\")]),s._v(\" /etc/keepalived\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"cp\")]),s._v(\" /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#cp /usr/local/keepalived-2.0.20/keepalived/keepalived.service /usr/lib/systemd/system/\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#systemctl daemon-reload\")]),s._v(\"\\nsystemctl start keepalived\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\")])]),t(\"h2\",{attrs:{id:\"概念\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#概念\"}},[s._v(\"#\")]),s._v(\" 概念\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"haproxy-2\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#haproxy-2\"}},[s._v(\"#\")]),s._v(\" Haproxy\")]),s._v(\" \"),t(\"p\",[s._v(\"HAProxy 是一款提供高可用性、负载均衡以及基于 TCP (第四层)和 HTTP\\n(第七层)应用的代理软件,支持虚拟主机，它是免费、快速并且可靠的一种解决\\n方案。 HAProxy 特别适用于那些负载特大的 web 站点，这些站点通常又需要会\\n话保持或七层处理。HAProxy 运行在时下的硬件上，完全可以支持数以万计的\\n并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中\\n同时可以保护你的 web 服务器不被暴露到网络上\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"haproxy-借助于-os-上几种常见的技术来实现性能最大化\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#haproxy-借助于-os-上几种常见的技术来实现性能最大化\"}},[s._v(\"#\")]),s._v(\" HAProxy 借助于 OS 上几种常见的技术来实现性能最大化\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"单进程、事件驱动模型显著降低了.上下文切换的开销及内存占用\")]),s._v(\" \"),t(\"li\",[s._v(\"在任何可用的情况下，单缓冲(single buffering)机制能以不复制任何数据的方式完成读写操作，这会节约大量的 CPU 时钟周期及内存带宽\")]),s._v(\" \"),t(\"li\",[s._v(\"借助于 Linux 2.6 (>= 2.6.27.19). 上的 splice()系统调用，HAProxy 可以实现零复制转发(Zero-copy forwarding),在 Linux 3.5 及以上的 OS 中还可以实现心零复制启动(zero-starting)\")]),s._v(\" \"),t(\"li\",[s._v(\"内存分配器在固定大小的内存池中可实现即时内存分配，这能够显著减少创 建一个会话的时长\")]),s._v(\" \"),t(\"li\",[s._v(\"树型存储:侧重于使用作者多年前开发的弹性二叉树，实现了以 O(log(N))的低开销来保持计时器命令、保持运行队列命令及管理轮询及最少连接队列\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"keepalive\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#keepalive\"}},[s._v(\"#\")]),s._v(\" keepAlive\")]),s._v(\" \"),t(\"p\",[s._v(\"KeepAlived 软件主要是通过 VRRP 协议实现高可用功能的。\")]),s._v(\" \"),t(\"p\",[s._v(\"VRRP 是 Virtual Router RedundancyProtocol(虚拟路由器冗余协议)的缩写,VRRP 出现的目的就是为了解决静态路由单点故障问题的，它能够保证当个别节点宕机时，整个网络可以不间断地运行所以，Keepalived 一方面具有配置管理 LVS 的功能，同时还具有对 LVS 下面节点进行健康检查的功能，另一方面也可实现系统网络服务的高可用功能\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"keepalive-的功能\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#keepalive-的功能\"}},[s._v(\"#\")]),s._v(\" keepAlive 的功能\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"管理 LVS 负载均衡软件\")]),s._v(\" \"),t(\"li\",[s._v(\"实现 LVS 集群节点的健康检查中\")]),s._v(\" \"),t(\"li\",[s._v(\"作为系统网络服务的高可用性(failover)\")])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"keepalive-高可用原理\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#keepalive-高可用原理\"}},[s._v(\"#\")]),s._v(\" keepAlive 高可用原理\")]),s._v(\" \"),t(\"p\",[s._v(\"Keepalived 高可用服务对之间的故障切换转移，是通过 VRRP (Virtual RouterRedundancy Protocol ,虚拟路由器冗余协议)来实现的。在 Keepalived 服务正常工作时，主 Master 节点会不断地向备节点发送( 多播的方式)心跳消息，用以告诉备 Backup 节点自己还活看，当主 Master 节点发生故障时，就无法发送心跳消息，备节点也就因此无法继续检测到来自主 Master 节点的心跳了，于是调用自身的接管程序，接管主 Master 节点的 IP 资源及服务。而当主 Master 节点恢复时备 Backup 节点又会释放主节点故障时自身接管的 IP 资源及服务，恢复到原来的备用角色\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"搭建-rabbitmq-高可用集群\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#搭建-rabbitmq-高可用集群\"}},[s._v(\"#\")]),s._v(\" 搭建 RabbitMQ 高可用集群\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"部署情况\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#部署情况\"}},[s._v(\"#\")]),s._v(\" 部署情况\")]),s._v(\" \"),t(\"p\",[s._v(\"修改三个节点（rabbitmq_node1、rabbitmq_node2、rabbitmq_node3）主机名，然后修改 hosts 配置文件\")]),s._v(\" \"),t(\"p\",[s._v(\"在 rabbitmq-node1、 rabbitmq-node2、 rabbitmq-node3 节点\"),t(\"RouterLink\",{attrs:{to:\"/backend/middleware/RabbitMQ/#centos\"}},[s._v(\"安装 RabbitMQ\")])],1),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" /etc/hostname\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" /etc/hosts\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".123.36 rabbitmq-node1\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".123.162 rabbitmq-node2\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".123.104 rabbitmq-node3\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\")])]),t(\"table\",[t(\"thead\",[t(\"tr\",[t(\"th\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"服务器 IP\")]),s._v(\" \"),t(\"th\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"hostname\")]),s._v(\" \"),t(\"th\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"节点说明\")]),s._v(\" \"),t(\"th\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"端口\")]),s._v(\" \"),t(\"th\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"地址\")])])]),s._v(\" \"),t(\"tbody\",[t(\"tr\",[t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"192.168.123.36\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"rabbitmq-node1\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"rabbitmq msater\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"5672\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"http://192.168.123.36:15672\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"192.168.123.162\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"rabbitmq-node2\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"rabbitmq slave\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"5672\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"http://192.168.123.162:15672\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"192.168.123.104\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"rabbitmq-node3\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"rabbitmq slave\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"5672\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"http://192.168.123.104:15672\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"192.168.123.11\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"haproxy-keeplive-node1\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"haproxy + keeplive\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"8100\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"http://192.168.123.11:8100/rabbitmq-stats\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"192.168.123.220\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"haproxy-keeplive-node2\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"haproxy + keeplive\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"8100\")]),s._v(\" \"),t(\"td\",{staticStyle:{\"text-align\":\"center\"}},[s._v(\"http://192.168.123.220:8100/rabbitmq-stats\")])])])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"rabbitmq-集群搭建\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#rabbitmq-集群搭建\"}},[s._v(\"#\")]),s._v(\" RabbitMQ 集群搭建\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[s._v(\"拷贝 cookie\")])]),s._v(\" \"),t(\"p\",[s._v(\"将 rabbitmq-node1 上的 .erlang.cookie 文件拷贝到其他两台主机上。该 cookie 文件相当于密钥令牌，集群中的 RabbitMQ 节点需要通过交换密钥令牌以获得相互认证，因此处于同一集群的所有节点需要具有相同的密钥令牌，否则在搭建过程中会出现 Authentication Fail 错误\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#备份rabbitmq_node2和rabbitmq_node3原有cookie文件\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"cp\")]),s._v(\" /var/lib/rabbitmq/.erlang.cookie /var/lib/rabbitmq/.erlang.cookie.bak\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#在复制的时候需要临时修改cookie文件的权限\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#chmod 777 /var/lib/rabbitmq/.erlang.cookie\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#在rabbitmq_node1上执行\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"scp\")]),s._v(\" /var/lib/rabbitmq/.erlang.cookie \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".123.162:/var/lib/rabbitmq/\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"scp\")]),s._v(\" /var/lib/rabbitmq/.erlang.cookie \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".123.104:/var/lib/rabbitmq/\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#拷贝完毕后再把权限修改回来\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#chmod 400 /var/lib/rabbitmq/.erlang.cookie\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"2\"}},[t(\"li\",[s._v(\"启动服务\")])]),s._v(\" \"),t(\"p\",[s._v(\"同时启动 Erlang 虚拟机和 RabbitMQ 应用服务。\"),t(\"code\",[s._v(\"rabbitmqctl start_app\")]),s._v(\" 只会启动 RabbitMQ 应用服务， \"),t(\"code\",[s._v(\"rabbitmqctl stop_app\")]),s._v(\" 只会停止 RabbitMQ 应用服务\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"rabbitmq-server start -detached\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"ol\",{attrs:{start:\"3\"}},[t(\"li\",[s._v(\"集群搭建\")])]),s._v(\" \"),t(\"p\",[s._v(\"RabbitMQ 集群的搭建需要选择其中任意一个节点为基准，将其它节点逐步加入。这里我们以 rabbitmq-node1 为基准节点，将 rabbitmq-node2 和 rabbitmq-node3 加入集群\")]),s._v(\" \"),t(\"p\",[s._v(\"在 rabbitmq-node2 和 rabbitmq-node3 上执行以下命令\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"rabbitmqctl stop_app\\nrabbitmqctl reset\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#默认是磁盘节点，如果是内存节点的话，需要加--ram参数\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#rabbitmqctl join_cluster --ram rabbit@node\")]),s._v(\"\\nrabbitmqctl join_cluster rabbit@rabbitmq-node1\\nrabbitmqctl start_app\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\")])]),t(\"p\",[s._v(\"如果节点以磁盘节点的形式加入，则需要先使用 reset 命令进行重置，然后才能加入现有群集，重置节点会删除该节点上存在的所有的历史资源和数据。采用内存节点的形式加入时可以略过 reset 这一步，因为内存上的数据本身就不是持久化的\")]),s._v(\" \"),t(\"ol\",{attrs:{start:\"4\"}},[t(\"li\",[s._v(\"集群操作\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#查看集群状态\")]),s._v(\"\\nrabbitmqctl cluster_status\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#剔除集群节点\")]),s._v(\"\\nrabbitmqctl forget_cluster_node rabbit@rabbitmq-node2\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#修改集群名称\")]),s._v(\"\\nrabbitmqctl set_cluster_name rabbitmq_cluster1\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#更改节点类型 磁盘节点和内存节点 集群中必须至少有一个磁盘节点，否则队列元数据无法写入到集群中，当磁盘节点宕掉时，集群将无法写入新的队列元数据信息\")]),s._v(\"\\nrabbitmqctl change_cluster_node_type disc \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"|\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"ram\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\")])]),t(\"h3\",{attrs:{id:\"配置镜像队列\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#配置镜像队列\"}},[s._v(\"#\")]),s._v(\" 配置镜像队列\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#在任意一个节点上执行\")]),s._v(\"\\nrabbitmqctl set_policy ha-all \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"^\"')]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\\'{\"ha-mode\":\"all\"}\\'')]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\")])]),t(\"p\",[s._v(\"我们指定了 ha-mode 的值为 all ，代表消息会被同步到所有节点的相同队列中。这里我们之所以这样配置，因为我们本身只有三个节点，因此复制操作的性能开销比较小。如果你的集群有很多节点，那么此时复制的性能开销就比较大，此时需要选择合适的复制系数。通常可以遵循过半写原则，即对于一个节点数为 n 的集群，只需要同步到 n/2+1 个节点上即可。此时需要同时修改镜像策略为 exactly，并指定复制系数 ha-params\\n，示例如下：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"rabbitmqctl set_policy ha-two \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"^\"')]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\\'{\"ha-mode\":\"exactly\",\"ha-params\":2,\"ha-sync-mode\":\"automatic\"}\\'')]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"p\",[s._v(\"除此之外，RabbitMQ 还支持使用正则表达式来过滤需要进行镜像操作的队列，示例如下：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"rabbitmqctl set_policy ha-all \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"^ha\\\\.\"')]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\\'{\"ha-mode\":\"all\"}\\'')]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"p\",[s._v(\"此时只会对 ha 开头的队列进行镜像。更多镜像队列的配置说明，可以参考官方文档\"),t(\"a\",{attrs:{href:\"https://www.rabbitmq.com/ha.html\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"https://www.rabbitmq.com/ha.html\"),t(\"OutboundLink\")],1)]),s._v(\" \"),t(\"h3\",{attrs:{id:\"haproxy-环境搭建\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#haproxy-环境搭建\"}},[s._v(\"#\")]),s._v(\" HAProxy 环境搭建\")]),s._v(\" \"),t(\"p\",[s._v(\"在 haproxy-keeplive-node1、haproxy-keeplive-node2 节点\"),t(\"RouterLink\",{attrs:{to:\"/backend/middleware/HAProxy/#源码安装\"}},[s._v(\"安装 Haproxy\")])],1),s._v(\" \"),t(\"h4\",{attrs:{id:\"配置-2\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#配置-2\"}},[s._v(\"#\")]),s._v(\" 配置\")]),s._v(\" \"),t(\"div\",{staticClass:\"language- line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[s._v('vim /etc/haproxy/haproxy.cfg\\n\\n# 全局配置\\nglobal\\n    # 日志输出配置、所有日志都记录在本机，通过 local0 进行输出\\n    log 127.0.0.1 local0 info\\n    # 最大连接数\\n    maxconn 4096\\n    # 改变当前的工作目录\\n    chroot /usr/local/haproxy\\n    # 以指定的 user 运行 haproxy 进程\\n    user haproxy\\n    # 以指定的 group 运行 haproxy 进程\\n    group haproxy\\n    # 以守护进行的方式运行\\n    daemon\\n    # 当前进程的 pid 文件存放位置\\n    pidfile /var/run/haproxy.pid\\n\\n# 默认配置\\ndefaults\\n    # 应用全局的日志配置\\n    log global\\n    # 使用4层代理模式，7层代理模式则为\"http\"\\n    mode tcp\\n    # 日志类别\\n    option tcplog\\n    # 不记录健康检查的日志信息\\n    option dontlognull\\n    # 3次失败则认为服务不可用\\n    retries 3\\n    # 每个进程可用的最大连接数\\n    maxconn 2000\\n    # 连接超时\\n    timeout connect 5s\\n    # 客户端超时\\n    timeout client 120s\\n    # 服务端超时\\n    timeout server 120s\\n\\n# 绑定配置\\nlisten rabbitmq_cluster\\n    bind 0.0.0.0:5672\\n    # 配置TCP模式\\n    mode tcp\\n    # 采用加权轮询的机制进行负载均衡\\n    balance roundrobin\\n    # RabbitMQ 集群节点配置\\n    server rabbitmq-node1 192.168.123.36:5672 check inter 5000 rise 2 fall 2 weight 1\\n   \\tserver rabbitmq-node2 192.168.123.162:5672 check inter 5000 rise 2 fall 2 weight 1\\n   \\tserver rabbitmq-node3 192.168.123.104:5672 check inter 5000 rise 2 fall 2 weight 1\\n\\n# 配置监控页面\\nlisten monitor\\n    bind :8100\\n    mode http\\n    option httplog\\n    stats enable\\n    stats uri /rabbitmq-stats\\n    stats refresh 5s\\n')])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"22\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"23\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"24\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"25\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"26\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"27\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"28\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"29\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"30\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"31\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"32\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"33\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"34\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"35\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"36\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"37\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"38\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"39\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"40\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"41\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"42\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"43\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"44\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"45\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"46\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"47\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"48\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"49\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"50\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"51\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"52\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"53\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"54\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"55\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"56\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"57\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"58\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"59\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"60\")]),t(\"br\")])]),t(\"h4\",{attrs:{id:\"启动服务\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#启动服务\"}},[s._v(\"#\")]),s._v(\" 启动服务\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"systemctl start haproxy\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"h3\",{attrs:{id:\"keepalived-环境搭建\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#keepalived-环境搭建\"}},[s._v(\"#\")]),s._v(\" KeepAlived 环境搭建\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"在-haproxy-keeplive-node1、haproxy-keeplive-node2-节点安装-keepalived\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#在-haproxy-keeplive-node1、haproxy-keeplive-node2-节点安装-keepalived\"}},[s._v(\"#\")]),s._v(\" 在 haproxy-keeplive-node1、haproxy-keeplive-node2 节点\"),t(\"RouterLink\",{attrs:{to:\"/backend/middleware/HAProxy/#keepalived\"}},[s._v(\"安装 KeepAlived\")])],1),s._v(\" \"),t(\"h4\",{attrs:{id:\"配置-3\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#配置-3\"}},[s._v(\"#\")]),s._v(\" 配置\")]),s._v(\" \"),t(\"p\",[s._v(\"修改 haproxy-keeplive-node1 节点上 keepalived.conf 配置文件\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" /etc/keepalived/keepalived.conf\\n\\nglobal_defs \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n   \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 路由id,主备节点不能相同\")]),s._v(\"\\n   router_id node1\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 自定义监控脚本\")]),s._v(\"\\nvrrp_script chk_haproxy \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 脚本位置\")]),s._v(\"\\n    script \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/etc/keepalived/haproxy_check.sh\"')]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 脚本执行的时间间隔\")]),s._v(\"\\n    interval \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5\")]),s._v(\"\\n    weight -20\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\nvrrp_instance VI_1 \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# Keepalived的角色，MASTER 表示主节点，BACKUP 表示备份节点\")]),s._v(\"\\n    state MASTER\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 指定监测的网卡，可以使用 ifconfig 进行查看\")]),s._v(\"\\n    interface ens33\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 虚拟路由的id，主备节点需要设置为相同\")]),s._v(\"\\n    virtual_router_id \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 优先级，主节点的优先级需要设置比备份节点高\")]),s._v(\"\\n    priority \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"100\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 设置主备之间的检查时间，单位为秒\")]),s._v(\"\\n    advert_int \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 定义验证类型和密码\")]),s._v(\"\\n    authentication \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        auth_type PASS\\n        auth_pass \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"123456\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 调用上面自定义的监控脚本\")]),s._v(\"\\n    track_script \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        chk_haproxy\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n    virtual_ipaddress \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 虚拟IP地址，可以设置多个\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.123\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"22\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"23\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"24\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"25\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"26\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"27\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"28\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"29\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"30\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"31\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"32\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"33\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"34\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"35\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"36\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"37\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"38\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"39\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"40\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"41\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"42\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"43\")]),t(\"br\")])]),t(\"p\",[s._v(\"以上配置定义了 haproxy-keeplive-node1 上的 Keepalived 节点为 MASTER 节点，并设置对外提供服务的虚拟 IP 为 192.168.0.123。此外最主要的是定义了通过 haproxy_check.sh 来对 HAProxy 进行监控\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" /etc/keepalived/haproxy_check.sh\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#!/bin/bash\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 判断haproxy是否已经启动\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[t(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"ps\")]),s._v(\" -C haproxy --no-header \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"|\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"wc\")]),s._v(\" -l\"),t(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\" -eq \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"then\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#如果没有启动，则启动\")]),s._v(\"\\n    systemctl start haproxy\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#睡眠3秒以便haproxy完全启动\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"sleep\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),s._v(\"\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#如果haproxy还是没有启动，此时需要将本机的keepalived服务停掉，以便让VIP自动漂移到另外一台haproxy\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[t(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"ps\")]),s._v(\" -C haproxy --no-header \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"|\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"wc\")]),s._v(\" -l\"),t(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\" -eq \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"then\")]),s._v(\"\\n        systemctl stop keepalived\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"fi\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"fi\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#赋予执行权限\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"chmod\")]),s._v(\" +x /etc/keepalived/haproxy_check.sh\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\")])]),t(\"p\",[s._v(\"这个脚本主要用于判断 HAProxy 服务是否正常，如果不正常且无法启动，此时就需要将本机 Keepalived 关闭，从而让虚拟 IP 漂移到备份节点。备份节点的配置与主节点基本相同，但是需要修改其 state 为 BACKUP；同时其优先级 priority 需要比主节点低\")]),s._v(\" \"),t(\"p\",[s._v(\"修改 haproxy-keeplive-node2 节点上 keepalived.conf 配置文件\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" /etc/keepalived/keepalived.conf\\n\\nglobal_defs \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n   \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 路由id,主备节点不能相同\")]),s._v(\"\\n   router_id node2\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\nvrrp_script chk_haproxy \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    script \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/etc/keepalived/haproxy_check.sh\"')]),s._v(\"\\n    interval \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5\")]),s._v(\"\\n    weight -20\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\nvrrp_instance VI_1 \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# BACKUP 表示备份节点\")]),s._v(\"\\n    state BACKUP\\n    interface ens33\\n    virtual_router_id \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 优先级，备份节点要比主节点低\")]),s._v(\"\\n    priority \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"90\")]),s._v(\"\\n    advert_int \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"\\n    authentication \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        auth_type PASS\\n        auth_pass \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"123456\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n    track_script \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        chk_haproxy\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n    virtual_ipaddress \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.123\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"22\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"23\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"24\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"25\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"26\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"27\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"28\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"29\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"30\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"31\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"32\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"33\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"34\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"35\")]),t(\"br\")])]),t(\"h4\",{attrs:{id:\"启动服务-2\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#启动服务-2\"}},[s._v(\"#\")]),s._v(\" 启动服务\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-shell line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-shell\"}},[t(\"code\",[s._v(\"systemctl start  keepalived\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"div\",{staticClass:\"custom-block warning\"},[t(\"p\",{staticClass:\"custom-block-title\"},[s._v(\"WARNING\")]),s._v(\" \"),t(\"p\",[s._v(\"SECURITY VIOLATION - scripts are being executed but script_security not enabled\")])]),s._v(\" \"),t(\"p\",[s._v(\"确认脚本可以手动执行，是否有执行权限\")])])}),[],!1,null,null,null);a.default=n.exports}}]);","extractedComments":[]}